class LocationsUtility

  def self.locations
    return {
      'Colorado' => [
        'Arapahoe',
        'Aurora Centrepoint',
        'Baseline',
        'Briargate',
        'Brighton',
        'Castle Rock',
        'Central Support',
        'Colorado Springs',
        'East Denver',
        'Educational Theater',
        'Emergency',
        'Englewood',
        'Evergreen',
        'Fort Collins',
        'Franklin',
        'Greeley Medical Office',
        'Greenwood Plaza',
        'Hidden Lake',
        'Highlands Ranch',
        'Ken Caryl',
        'Lakewood',
        'Denver Highlands',
        'Lone Tree',
        'Longmont',
        'Loveland',
        'Lowry',
        'Parker',
        'Pueblo',
        'Regional/Highline',
        'Ridgeline Behavioral Health',
        'Rock Creek',
        'Skyline',
        'Smoky Hill',
        'Southwest',
        'Stapleton',
        'Waterpark I',
        'Waterpark II',
        'Waterpark III',
        'Westminster',
        'Wheat Ridge',
        'Yosemite South Medical Office',
        'Other'
      ],
      'Georgia' => [
        'Alpharetta Medical Offices',
        'Athens Medical Office Bldg.',
        'Brookwood Medical Office',
        'Cascade Medical Offices',
        'Conyers Medical Office',
        'Crescent Center Medical Ofcs',
        'Cumberland Medical Offices',
        'Decatur Medical Office',
        'Dekalb Med Ctr',
        'Dekalb Tech Bldg 200',
        'Dekalb Tech Bldg 400',
        'Dekalb Tech Bldg. 300',
        'Douglasville',
        'Fayetteville Medical Office',
        'Float Pool',
        'Glenlake Medical Offices',
        'Gwinnett Med Ctr',
        'Henry Towne Center',
        'Holly Springs Medical Office',
        'Lawrenceville Medical Offices',
        'Newnan Medical Office',
        'Northside Forsyth MO',
        'Northside Hospital',
        'Panola Medical offices',
        'Piedmont Specialty Center',
        'Regional Office - 10 Piedmont',
        'Regional Office - 11 Piedmont',
        'Regional Office - 9 Piedmont',
        'Sandy Springs MOB',
        'Scottish Rite',
        'Sheffield Medical Offices',
        'Snellville',
        'Southwood Medical Offices',
        'Southwood Specialties',
        'Stonecrest MO',
        'Sugar Hill Buford Medical Ofcs',
        'Town Park Comprehensive Med Center',
        'West Cobb Medical Offices',
        'Other'
      ],
      'Hawaii' => [
        'Ala Moana',
        'Central Support Services',
        'Daly City Medical Offices',
        'Dole Service Center',
        'Halawa',
        'Hawaii Kai Medical Offices',
        'Hilo Medical Offices',
        'Honolulu Medical Office',
        'Kahuku Medical Offices',
        'Kailua Medical Offices',
        'Kapolei Medical Offices',
        'Kauai',
        'Kihei Medical Offices',
        'Kona Medical Offices',
        'Koolau Medical Offices',
        'KPIT - Dole Annex',
        'Lahaina Medical Offices',
        'Lanai',
        'Mapunapuna Medical Offices',
        'Maui Lani Medical Offices',
        'Mililani Clinic',
        'Mililani Tech Park',
        'Moanalua Medical Center',
        'Molokai',
        'Nanaikeola Medical Offices',
        'Ohohia Support Services',
        'Pearlridge',
        'Punawai Support Services',
        'Rainbow Dialysis',
        'Regional Administrative Office',
        'Skilled Nursing Facility',
        'South Kona Medical Offices',
        'Wailuku Medical Offices',
        'Wailuku Weinberg',
        'Wailuku Wells Street',
        'Waimea Medical Offices',
        'Waipio Medical Offices',
        'Other'
      ],
      'IT (all locations)' => [
        '(all locations)'
      ],
      'Mid-Atlantic States' => [
        'Annapolis Medical Center',
        'Ashburn Medical Center',
        'Baltimore Sales & Marketing Office',
        'Beltsville Warehouse',
        'Burke Medical Center',
        'Camp Springs Medical Center',
        'Capitol Hill Medical Office',
        'Central Pharmacy - Sterling',
        'Children\'s National Medical Center',
        'City Plaza Medical Center',
        'Columbia Gateway Medical Center',
        'Customer Service Center',
        'Fair Oaks Medical Center',
        'Falls Church Medical Center',
        'Frederick Medical Center',
        'Fredericksburg Medical Office',
        'Gaithersburg Medical Office',
        'GBMC Medical Offices',
        'Holy Cross Hosptial',
        'Kensington Medical Center',
        'Largo Health Center',
        'Manassas Medical Center',
        'Maple Lawn',
        'Marlow Heights Medical Center',
        'Mary Washington Hospital',
        'Northwest Medical Center',
        'Prince George Medical Center',
        'Regional Office',
        'Regional Offices-Garrett',
        'Reston Medical Center',
        'Rockville Regional Laboratory',
        'Severna Park Medical Center',
        'Shady Grove Medical Center',
        'Sibley Memorial Hospital',
        'Silver Spring Data Center',
        'Silver Spring Medical Center',
        'South Baltimore Medical Office',
        'Springfield Medical Center',
        'St. Agnes Hospital',
        'Suburban Hospital',
        'Summit Medical Center',
        'Talbot Admin Building',
        'Technical Services Center',
        'Towson Medical Center',
        'Tysons Corner Medical Office',
        'Virginia Hospital Center',
        'Vision Services Burtonsville',
        'Washington Hospital Center',
        'White Marsh Medical Center',
        'Woodbridge Medical Center',
        'Woodlawn Medical Center',
        'Other'
      ],
      'Northern California' => [
        'AACC (Call Center) - 1800 Harrison',
        'AACC (Call Center) - Sacramento',
        'AACC (Call Center) - San Jose',
        'AACC (Call Center) - Vallejo',
        'Central Valley Area - Manteca Medical Offices',
        'Central Valley Area - Modesto Medical Center',
        'Central Valley Area - Stockton Medical Offices',
        'Central Valley Area - Tracy Medical Offices',
        'Diablo Area - Antioch Delta Fair',
        'Diablo Area - Antioch Medical Center',
        'Diablo Area - Livermore',
        'Diablo Area - Martinez',
        'Diablo Area - Park Shadelands',
        'Diablo Area - Pleasanton',
        'Diablo Area - San Ramon',
        'Diablo Area - Walnut Creek Medical Center',
        'East Bay Area - Alameda MOB',
        'East Bay Area - Oakland Medical Center',
        'East Bay Area - Pinole MOB',
        'East Bay Area - Richmond Medical Center',
        'Fresno Area - Blackstone',
        'Fresno Area - Clovis',
        'Fresno Area - First Street',
        'Fresno Area - Fresno Medical Center',
        'Fresno Area - Oakhurst',
        'Fresno Area - Selma',
        'Fresno Area - Shaw',
        'GSAA - Creekside San Leandro',
        'GSAA - Fremont Medical Center',
        'GSAA - Hayward Medical Center',
        'GSAA - San Leandro Medical Center',
        'GSAA - Union City Landing',
        'GSAA - Union City MOB',
        'Marin-Sonoma Area - Novato Medical Offices (inc Redwood)',
        'Marin-Sonoma Area - Petaluma  Medical Offices',
        'Marin-Sonoma Area - Rohnert Park',
        'Marin-Sonoma Area - San Rafael Medical Center (inc SRD, MV, LG, SRR)',
        'Marin-Sonoma Area -Santa Rosa',
        'Napa Solano Area - Fairfield MOB',
        'Napa Solano Area - Napa MOB',
        'Napa Solano Area - Vacaville Medical Center',
        'Napa Solano Area - Vallejo Medical Center',
        'North Valley Area - Arden Complex',
        'North Valley Area - Bell Street',
        'North Valley Area - CDRP',
        'North Valley Area - Davis MOB',
        'North Valley Area - East Roseville Parkway',
        'North Valley Area - Fair Oaks MOB',
        'North Valley Area - Folsom Ambulatory Center',
        'North Valley Area - Folsom MOB',
        'North Valley Area - Gibson Facility',
        'North Valley Area - Lava Ridge',
        'North Valley Area - Lincoln MOB',
        'North Valley Area - Point West MOB',
        'North Valley Area - Professional Drive',
        'North Valley Area - Rancho Cordova MOB',
        'North Valley Area - Riverside MOB',
        'North Valley Area - Roseville Medical Center',
        'North Valley Area - Sacramento Medical Center',
        'North Valley Area - Sierra Gardens',
        'Regional Labs - Berkeley',
        'Regional Labs - Richmond MWS',
        'Regional Optical - Richmond Optical Lab',
        'Regional Offices - Berkeley Clinical Technology',
        'Regional Offices - Division of Research',
        'Regional Offices - Downtown Oakland (1950, 1800, 2101, 1438)',
        'Regional Offices - HR Service Center (Alameda)',
        'Regional Offices - KP School of Allied Health Sciences',
        'Regional Offices - Livermore (LRDC)',
        'Regional Offices - OPDC',
        'Regional Offices - Other',
        'Regional Offices - Pleasanton (KPHC)',
        'Regional Offices - San Leandro (KPPACC)',
        'Regional Offices - Stockton',
        'Regional Offices - Walnut Creek (2880 Shadelands, 501 Lennon, Mitchell, Treat, Via Monte)',
        'San Francisco Area - French Campus',
        'San Francisco Area - San Francisco Medical Center',
        'San Jose Area - Gilroy Medical Offices',
        'San Jose Area - San Jose Medical Center',
        'San Mateo Area - Redwood City Medical Center',
        'San Mateo Area - South San Francisco, Daly City, San Bruno',
        'Santa Clara Area - Campbell Medical Offices',
        'Santa Clara Area - Milpitas Medical Offices',
        'Santa Clara Area - Mountain View Medical Offices',
        'Santa Clara Area - Santa Clara Medical Center',
        'South Sacramento Area - Elk Grove Medical Offices',
        'South Sacramento Area - South Sacramento Medical Center',
        'South Sacramento Area - South Valley Medical Offices',
        'South Sacramento Area - Wyndham Medical Offices',
        'Other'
      ],
      'Northwest' => [
        '5800 Meadows Road IT Facility',
        '6000 Meadows Road IT Facility',
        'Airport Way Center',
        'Aloha Dental',
        'Beaverton Medical/Dental Office',
        'Brookside Residential Treatment Facility',
        'Center for Health Research',
        'Clackamas Dental Office',
        'Clackamas Eye Care',
        'Clackamas Sleep Lab',
        'Eastman Parkway Office',
        'Eastmoreland Dental Office',
        'Gateway Medical Office',
        'Glisan Dental Office',
        'Grand Avenue Dental Office',
        'Gresham Dental Office',
        'Hillsboro Medical Office',
        'Interstate - Central Medical Office',
        'Interstate - East Medical Office',
        'Interstate - Oncology',
        'Interstate - South Medical Office',
        'Interstate - West Medical Office',
        'Kaiser Permanente Building',
        'Keizer Station MOB',
        'Lake Road Dialysis',
        'Lloyd 700 Building',
        'Longview/Kelso Medical Office',
        'Montgomery Park Center',
        'Mt. Scott Medical Office',
        'Mt. Talbert Medical Office',
        'Murrayhill Medical Office',
        'Nicolai Service Center',
        'North Interstate ',
        'North Lancaster Dental Office',
        'North Lancaster Medical Office',
        'Northwest Regional Lab',
        'One Town Center',
        'Oregon City Dental Office',
        'Overlook Park Building',
        'Regional Call Center',
        'Regional Process Center',
        'Regional Supply Center',
        'Rockwood Dental Office',
        'Rockwood Medical Office',
        'Salem Call Center',
        'Skyline Dental Office',
        'Skyline Medical Office',
        'Sunnybrook Medical Office',
        'Sunnyside Medical Center',
        'Sunnyside Security House',
        'Sunset Dental Office',
        'Sunset Medical Center',
        'Tigard Dental Office',
        'Town Hall',
        'Tualatin Medical Office',
        'Walker Road Nephrology',
        'West Salem Medical Office',
        'Westside Medical Center',
        'Westside Specialty Medical Offices',
        'Other'
      ],
      'Program Offices' => [
        '1 Kaiser Plaza (Ordway)',
        '10350 E Dakota Ave',
        '10990 San Diego Mission Road',
        '11900 A Bournefield Way',
        '11941-N Bournefield Way',
        '11961 Bournefield Way',
        '12254 Bellflower Blvd.',
        '1305 Tommydon Street',
        '1425 S Main Street',
        '1451 Harbor Bay Pkwy',
        '1800 Harrison',
        '1840 California Avenue',
        '1850 California Avenue',
        '1950 Franklin',
        '2100 Powell Street',
        '2101 E Jefferson St',
        '2101 Webster Street',
        '2221 Broad Birch Drive',
        '25 N Via Monte',
        '2500 S Havana St',
        '2550 S Parker Rd',
        '2701 NW Vaughn Street',
        '2850 NW Nicolai Street',
        '2880 Shadelands',
        '300 Lakeside (Kaiser Center)',
        '3100 Thornton Avenue',
        '312 Stonemill Drive',
        '3200 Arden Way',
        '3495 Piedmont Road NE',
        '36 British American Blvd.',
        '3840 Murphy Canyon Road',
        '393 E Walnut Street',
        '4460 Hacienda Drive',
        '4900 SW Meadows Rd',
        '500 NE Multnomah St',
        '501 Lennon Lane',
        '5400 Lancaster Drive',
        '5600 Stoneridge Mall Rd',
        '5780 Peachtree Dunwoody Rd',
        '5800 Medows',
        '680 Iwilei Road',
        '74 N Pasadena Ave',
        '75 North Fair Oaks',
        '7901 East Lowry Blvd',
        '815 W Colorado Blvd',
        '825 Colorado Blvd.',
        '99 S Oakland Ave',
        'Other'
      ],
      'Southern California' => [
        '3100 Thornton Avenue',
        'Annandale One',
        'Annandale Two',
        'Antelope Valley Medical Center',
        'Baldwin Park Medical Center',
        'California Service Center #1',
        'California Service Center #2',
        'California Service Center #3',
        'California Service Center - San Diego',
        'Chino Warehouse',
        'Corona Member Service Call Center',
        'Corona Admin Center',
        'Corona Data Center',
        'Corona Regional Call Center',
        'Downey Medical Center',
        'Educational Outreach',
        'Empire Corporate Plaza',
        'Fontana Medical Center',
        'Foothill Center',
        'Glendale Center',
        'Green Street Administrative Offices',
        'Independence Park',
        'Irvine Medical Center',
        'Kern County Medical Center',
        'KP On Call',
        'Lakeview Administrative Office',
        'Los Angeles Regional Service Center',
        'Los Angeles Medical Center',
        '100 South Los Robles',
        'Member Call Center',
        'Moreno Valley Community Hospital',
        'Ontario Medical Center',
        'Ontario Records Center',
        'Orange County Medical Center',
        'Panorama City Medical Center',
        'Parsons East Annex',
        'Parsons West Annex',
        'Pharmacy Refill Center',
        'Regional Service Center',
        'Rio San Diego Plaza',
        'Riverside Medical Center',
        'San Diego Member Services Correspondence Unit',
        'San Diego Medical Center',
        'Santa Fe Springs Admin',
        'Sherman Way Lab East',
        'Sherman Way Lab West',
        'South Bay Medical Center',
        'Vernon Manufacturing Bldg 1',
        'Vernon Manufacturing Bldg 2',
        'Walnut Center',
        'Watts Counseling & Learning Center 1',
        'Watts Counseling & Learning Center 2',
        'West Los Angeles Medical Center',
        'Woodland Hills Medical Center',
        'Other'
      ]
    }
  end

  def self.build_locations(promotion_id)
    locations = self.locations
    location_map = []
    new_location_ids = []
    locations.each_with_index{ |(parent_location, child_locations), parent_idx|
      old_parent_location_id = nil
      old_parent_location = nil
      search = Location.where(:name => parent_location, :parent_location_id => nil, :promotion_id => promotion_id)
      if !search.empty?
        old_parent_location = search.first
        old_parent_location_id = old_parent_location.id
      else
        puts "Parent Location \"#{parent_location}\" not found."
      end
      pl = Location.create(:name => parent_location, :parent_location_id => nil, :promotion_id => promotion_id, :old_location_id => old_parent_location_id)

      location_map[old_parent_location_id] = pl.id if old_parent_location_id

      new_location_ids << pl.id
      child_locations.each_with_index{ |child_location, child_idx|
        old_child_location_id = nil
        old_child_location = nil
        search = Location.where(:name => child_location, :parent_location_id => old_parent_location_id, :promotion_id => promotion_id)
        if !search.empty?
          old_child_location = search.first
          old_child_location_id = old_child_location.id
        else
          puts "Child Location \"#{child_location}\" not found."
        end
        cl = Location.create(:name => child_location, :parent_location_id => pl.id, :promotion_id => promotion_id, :old_location_id => old_child_location_id)

        location_map[old_child_location_id] = cl.id if old_child_location_id

        new_location_ids << cl.id
      }
    }
    return [new_location_ids, location_map]
  end

  def self.run(promotion_id = 1)
    Promotion.transaction do

      new_location_ids, location_map = self.build_locations(promotion_id)

      old_location_ids = Promotion.find(promotion_id).locations.collect{ |l| l.id }

      models_to_update = [Banner, Challenge, Event, Forum, Resource, User]

      top_level_locations_not_found = []

      models_to_update.each{ |model|
        objects = model.where(:location_id => old_location_ids)
        i = 0
        objects.each{ |object|
          i = i + 1
          update_user_top_level = false
          if object.class.to_s == "User"
            update_user_top_level = true
          end

          old_location = Location.find(object.location_id) rescue nil
          old_location_display = old_location ? old_location.name + "  (#{old_location.id})" : "NULL"
          old_id = old_location.id.to_i
          old_id_display = old_location.id.to_s

          new_location = Location.find(location_map[old_location.id.to_i]) rescue nil
          new_location_display = new_location ? new_location.name + "  (#{new_location.id})" : "NULL"

          puts "Updating #{object.class.to_s} ##{object.id} (#{i}) from: #{old_location_display} location to: #{new_location_display}"
          

          update_attrs = {
            :location_id => location_map[object.location_id.to_i]
          }

          if update_user_top_level
            if location_map[object.top_level_location_id.to_i].nil?
              top_level_locations_not_found << object.top_level_location_id
            end
            update_attrs[:top_level_location_id] = location_map[object.top_level_location_id.to_i].nil? ? nil : location_map[object.top_level_location_id.to_i]
            top_level_sql_id = location_map[object.top_level_location_id.to_i].nil? ? "NULL" : location_map[object.top_level_location_id.to_i].to_s
          end

          object.update_attributes(update_attrs)

          if !object.valid?
            sql_location_id = location_map[old_id].nil? ? "NULL" : location_map[old_id]
            user_top_sql = update_user_top_level ? ", top_level_location_id = #{top_level_sql_id}" : ""

            sql = "UPDATE #{model.table_name} SET location_id = #{sql_location_id}#{user_top_sql} WHERE id = #{object.id}"

            puts "Invalid object: #{object.class.to_s} ##{object.id}"
            puts "Tried updating from: #{old_location_display} location to: #{new_location_display}"
            puts object.errors.full_messages.to_yaml
            puts "Manually updating via:"
            puts sql
            object.connection.execute(sql)

          else
            puts "Updated #{object.class.to_s} ##{object.id} from: #{old_location_display} location to: #{new_location_display}"
          end
        }
      }

    end
  end

end
